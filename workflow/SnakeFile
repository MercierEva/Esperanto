# -*- coding: utf-8 -*-
import os
import subprocess
import os
from Bio import SeqIO
import re
import gzip
import time
import pandas as pd

def count_seq(input_file):
    count=subprocess.Popen("zcat " + input_file + " | wc -l" , shell= True, stdout=subprocess.PIPE)
    out, err = count.communicate()
    return int(out.decode('utf-8'))

def filesCheck(wildcards):
    file = checkpoints.filtration.get(**wildcards).output[0]
    if count_seq(file) > int(config["params"]["coverage"]):           
        print("pass")
        pass_list=[]
        pass_list = expand(config["folder"]+"06_stats/report_{sample}_final.tsv", sample= wildcards.sample ) + expand(config["folder"]+"05_porechop/{sample}_ont.fasta", sample =wildcards.sample ) + expand(config["folder"]+"09_seq_inform/{sample}_SCAN.fa", sample=wildcards.sample)
        return pass_list
    else:     
        return expand(config["folder"]+"06_stats/Temp/{sample}_state.temp", sample=wildcards.sample)


configfile : "config_wf.yaml"
include: "rule_workflow.smk"

onsuccess:
    print("Le workflow est fini; vous pouvez récupérer les fasta ci-dessous")
    shell("rm .snakemake/log/*")

onerror:
    print("Le workflow ne s'est pas déroulé comme prévu...")



rule all:
    input:
        expand(config["folder"]+"06_stats/Temp/{sample}_finished.temp", sample=config["samples"]),
               

